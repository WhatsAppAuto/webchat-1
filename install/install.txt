cat <<EOF > /etc/apt/source.list
deb http://http.us.debian.org/debian/ stretch main
deb-src http://http.us.debian.org/debian/ stretch main
deb http://security.debian.org/debian-security stretch/updates main
deb-src http://security.debian.org/debian-security stretch/updates main
# stretch-updates, previously known as 'volatile'
deb http://http.us.debian.org/debian/ stretch-updates main
deb-src http://http.us.debian.org/debian/ stretch-updates main
EOF

apt-get update 
apt-get install -y locales-all
localectl set-locale LANG=pt_BR.UTF-8 LC_CTYPE=pt_BR.UTF-8
source /etc/default/locale
export LANG=pt_BR.UTF-8 LC_CTYPE=pt_BR.UTF-8 LC_ALL=pt_BR.UTF-8

apt-get install -y sudo net-tools wget ca-certificates git sqlite bash libmariadb-dev libpq-dev build-essential checkinstall gcc g++ python3-setuptools libmagic-dev libev-dev libgcrypt20-dev libxml2-dev libxslt1-dev libffi-dev fontconfig cython mariadb-client postgresql-client libmariadbclient-dev libdbus-glib-1-2 screen locales-all at nginx

apt-get install -y libreadline-gplv2-dev libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev
{
 apt install fonts-freefont-ttf
} ||
{
apt install ttf-freefont 
}

echo "www-data    ALL=NOPASSWD: /usr/local/webchat/bin/sudo.sh" > /etc/sudoers.d/webchat


# Python 3.7
cd /usr/src
wget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tgz
tar xzf Python-3.7.3.tgz
cd Python-3.7.3
./configure --enable-optimizations
make altinstall

# Golang
cd /usr/local
wget https://dl.google.com/go/go1.12.2.linux-amd64.tar.gz
tar xvf go1.12.2.linux-amd64.tar.gz

cat <<EOF >> /etc/profile
export GOROOT=/usr/local/go
export PATH=/usr/local/go/bin:$PATH
EOF

source /etc/profile 

pip3.7 install virtualenv
virtualenv /opt/webchatenv

git clone https://github.com/thiagosm/webchat.git /usr/local/webchat

/opt/webchatenv/bin/pip3 install -r /usr/local/webchat/requirements.txt 

python manage.py makemigrations
python manage.py migrate
python manage.py loaddata user
python manage.py loaddata source
python manage.py loaddata group
python manage.py loaddata script
python manage.py loaddata menu
python manage.py loaddata menuitem
python manage.py loaddata filter


cat <<EOF > /etc/nginx/sites-enabled/webchat
server {
    listen 7000;
    server_name _;
    root /var/www;
    index index.html index.htm;
    client_max_body_size 100M;
	location /static { alias /usr/local/webchat/static; }
	rewrite ^/$  	/admin/;    
	location / {
	    root /var/www;
	    proxy_pass http://unix:/run/gunicorn/webchat.socket;
	    include proxy_params;
	    access_log /var/log/nginx/webchat_access.log;
	    error_log /var/log/nginx/webchat_error.log;
	};
}
EOF


cp /usr/local/webchat/install/gunicorn_webchat.socket /etc/systemd/system/
cp /usr/local/webchat/install/gunicorn_webchat.service /etc/systemd/system/
cp /usr/local/webchat/install/webchat@.service /etc/systemd/system/
cp /usr/local/webchat/install/gunicorn.conf /etc/tmpfiles.d/

systemctl enable gunicorn_webchat.socket
systemctl enable gunicorn_webchat.service
systemctl enable nginx
systemctl start gunicorn_webchat.socket
systemctl start gunicorn_webchat.service
systemctl stop nginx
systemctl start nginx 








    

